name: Deploy application for preview

on:
  pull_request:
    types: [opened, synchronize, reopened]
  workflow_dispatch:

concurrency:
  group: deploy-preview-${{ github.event.pull_request.number }}
  cancel-in-progress: true

jobs:
  deploy_application_for_preview:
    name: CD workflow
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Wait for Render preview deployment
        env:
          RENDER_API_KEY: ${{ secrets.RENDER_API_KEY }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
        run: |
          set -euo pipefail

          PR_SUFFIX="pr-${PR_NUMBER}"
          TIMEOUT=600
          INTERVAL=15
          ELAPSED=0

          echo "Looking for Render preview service for PR #${PR_NUMBER}..."

          while [ $ELAPSED -lt $TIMEOUT ]; do
            SERVICES=$(curl -fsSL \
              -H "Authorization: Bearer ${RENDER_API_KEY}" \
              "https://api.render.com/v1/services?limit=50")

            SERVICE_ID=$(echo "$SERVICES" | jq -r \
              '[.[].service | select(
                (.name | gsub(" "; "-") | gsub("#"; "") | ascii_downcase) |
                endswith("'"${PR_SUFFIX}"'")
              )] | first | .id // empty')

            if [ -z "$SERVICE_ID" ]; then
              echo "Service not found yet (${ELAPSED}s elapsed), retrying..."
              sleep $INTERVAL && ELAPSED=$((ELAPSED + INTERVAL)) && continue
            fi

            echo "Found service: $SERVICE_ID"

            DEPLOY=$(curl -fsSL \
              -H "Authorization: Bearer ${RENDER_API_KEY}" \
              "https://api.render.com/v1/services/${SERVICE_ID}/deploys?limit=1")

            STATUS=$(echo "$DEPLOY" | jq -r 'first | .deploy.status // empty')
            echo "Deploy status: ${STATUS:-unknown}"

            case "$STATUS" in
              live)
                echo "Deployment live!"; exit 0 ;;
              build_failed|update_failed|canceled|deactivated)
                echo "Deployment failed: $STATUS"; exit 1 ;;
              "")
                echo "No deployment found yet, retrying..." ;;
              *)
                echo "In progress ($STATUS), waiting..." ;;
            esac

            sleep $INTERVAL
            ELAPSED=$((ELAPSED + INTERVAL))
          done

          echo "ERROR: Timeout after ${TIMEOUT}s"
          exit 1
